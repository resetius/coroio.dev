\doxysection{resolver.\+hpp}
\hypertarget{resolver_8hpp_source}{}\label{resolver_8hpp_source}\index{coroio/resolver.hpp@{coroio/resolver.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ <exception>}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ <unordered\_map>}}
\DoxyCodeLine{00005\ }
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ "{}promises.hpp"{}}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ "{}socket.hpp"{}}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ "{}corochain.hpp"{}}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{keyword}{namespace\ }NNet\ \{}
\DoxyCodeLine{00011\ }
\DoxyCodeLine{00020\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_n_net_1_1_t_resolv_conf_ad5227778517c3517d6a041e576f64316}{TResolvConf}}\ \{}
\DoxyCodeLine{00021\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00027\ \ \ \ \ \mbox{\hyperlink{class_n_net_1_1_t_resolv_conf_ad5227778517c3517d6a041e576f64316}{TResolvConf}}(\textcolor{keyword}{const}\ std::string\&\ fn\ =\ \textcolor{stringliteral}{"{}/etc/resolv.conf"{}});}
\DoxyCodeLine{00036\ \ \ \ \ \mbox{\hyperlink{class_n_net_1_1_t_resolv_conf_a780072d84dd9401d940496cf9bef83a6}{TResolvConf}}(std::istream\&\ input);}
\DoxyCodeLine{00042\ \ \ \ \ std::vector<TAddress>\ \mbox{\hyperlink{class_n_net_1_1_t_resolv_conf_a2d4f6d8c2b74f4e31c350e4400f7da44}{Nameservers}};}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00045\ \ \ \ \ \textcolor{keywordtype}{void}\ Load(std::istream\&\ input);}
\DoxyCodeLine{00046\ \};}
\DoxyCodeLine{00047\ }
\DoxyCodeLine{00052\ \textcolor{keyword}{enum\ class}\ EDNSType\ \{}
\DoxyCodeLine{00053\ \ \ \ \ DEFAULT\ =\ 0,\ }
\DoxyCodeLine{00054\ \ \ \ \ A\ =\ 1,\ }
\DoxyCodeLine{00055\ \ \ \ \ AAAA\ =\ 28,\ }
\DoxyCodeLine{00056\ \};}
\DoxyCodeLine{00057\ }
\DoxyCodeLine{00083\ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ TPoller>}
\DoxyCodeLine{00084\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_n_net_1_1_t_resolver_a901c9a034e2f8d13ca7056dc893981ca}{TResolver}}\ \{}
\DoxyCodeLine{00085\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00095\ \ \ \ \ \mbox{\hyperlink{class_n_net_1_1_t_resolver_a901c9a034e2f8d13ca7056dc893981ca}{TResolver}}(TPoller\&\ poller,\ EDNSType\ defaultType\ =\ EDNSType::A);}
\DoxyCodeLine{00106\ \ \ \ \ \mbox{\hyperlink{class_n_net_1_1_t_resolver_aa21ad81f47fd798841e56fa1c4e7f0e3}{TResolver}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{class_n_net_1_1_t_resolv_conf}{TResolvConf}}\&\ conf,\ TPoller\&\ poller,\ EDNSType\ defaultType\ =\ EDNSType::A);}
\DoxyCodeLine{00116\ \ \ \ \ \mbox{\hyperlink{class_n_net_1_1_t_resolver_a5366c2f6beab03f1233bb515eaaa18fa}{TResolver}}(\mbox{\hyperlink{class_n_net_1_1_t_address}{TAddress}}\ dnsAddr,\ TPoller\&\ poller,\ EDNSType\ defaultType\ =\ EDNSType::A);}
\DoxyCodeLine{00117\ \ \ \ \ \mbox{\hyperlink{class_n_net_1_1_t_resolver_a901c9a034e2f8d13ca7056dc893981ca}{\string~TResolver}}();}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00132\ \ \ \ \ \mbox{\hyperlink{struct_n_net_1_1_t_future}{TFuture<std::vector<TAddress>}}>\ \mbox{\hyperlink{class_n_net_1_1_t_resolver_a03b305046ba4cd002ccf6f308cd8039f}{Resolve}}(\textcolor{keyword}{const}\ std::string\&\ hostname,\ EDNSType\ type\ =\ EDNSType::DEFAULT);}
\DoxyCodeLine{00133\ }
\DoxyCodeLine{00134\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00135\ \ \ \ \ \mbox{\hyperlink{struct_n_net_1_1_t_future}{TFuture<void>}}\ SenderTask();}
\DoxyCodeLine{00136\ \ \ \ \ \mbox{\hyperlink{struct_n_net_1_1_t_future}{TFuture<void>}}\ ReceiverTask();}
\DoxyCodeLine{00137\ \ \ \ \ \mbox{\hyperlink{struct_n_net_1_1_t_future}{TFuture<void>}}\ TimeoutsTask();}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00139\ \ \ \ \ \textcolor{keywordtype}{void}\ ResumeSender();}
\DoxyCodeLine{00140\ }
\DoxyCodeLine{00141\ \ \ \ \ \mbox{\hyperlink{struct_n_net_1_1_t_future}{TFuture<void>}}\ Sender;}
\DoxyCodeLine{00142\ \ \ \ \ \mbox{\hyperlink{struct_n_net_1_1_t_future}{TFuture<void>}}\ Receiver;}
\DoxyCodeLine{00143\ \ \ \ \ \mbox{\hyperlink{struct_n_net_1_1_t_future}{TFuture<void>}}\ Timeouts;}
\DoxyCodeLine{00144\ \ \ \ \ std::coroutine\_handle<>\ SenderSuspended;}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00146\ \ \ \ \ \mbox{\hyperlink{class_n_net_1_1_t_address}{TAddress}}\ DnsAddr;}
\DoxyCodeLine{00147\ \ \ \ \ \mbox{\hyperlink{class_n_net_1_1_t_socket}{TSocket}}\ Socket;}
\DoxyCodeLine{00148\ \ \ \ \ TPoller\&\ Poller;}
\DoxyCodeLine{00149\ \ \ \ \ EDNSType\ DefaultType;}
\DoxyCodeLine{00150\ }
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{keyword}{struct\ }TResolveRequest\ \{}
\DoxyCodeLine{00152\ \ \ \ \ \ \ \ \ std::string\ Name;}
\DoxyCodeLine{00153\ \ \ \ \ \ \ \ \ EDNSType\ Type;}
\DoxyCodeLine{00154\ }
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ operator==(\textcolor{keyword}{const}\ TResolveRequest\&\ other)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Name\ ==\ other.Name\ \&\&\ Type\ ==\ other.Type;}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00158\ }
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ hash()\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \ \ \ \ std::size\_t\ result\ =\ 0;}
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \ \ \ \ result\ \string^=\ std::hash<std::string>()(Name)\ +\ 0x9e3779b9\ +\ (result\ <<\ 6)\ +\ (result\ >>\ 2);}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ \ \ \ \ result\ \string^=\ std::hash<EDNSType>()(Type)\ +\ 0x9e3779b9\ +\ (result\ <<\ 6)\ +\ (result\ >>\ 2);}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00165\ \ \ \ \ \};}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{keyword}{struct\ }TResolveRequestHash}
\DoxyCodeLine{00168\ \ \ \ \ \{}
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ std::size\_t\ operator()(\textcolor{keyword}{const}\ TResolveRequest\&\ c)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00170\ \textcolor{keyword}{\ \ \ \ \ \ \ \ }\{}
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ c.hash();}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00173\ \ \ \ \ \};}
\DoxyCodeLine{00174\ }
\DoxyCodeLine{00175\ \ \ \ \ std::queue<TResolveRequest>\ AddResolveQueue;}
\DoxyCodeLine{00176\ \ \ \ \ std::queue<std::pair<TTime,\ TResolveRequest>>\ TimeoutsQueue;}
\DoxyCodeLine{00177\ }
\DoxyCodeLine{00178\ \ \ \ \ \textcolor{keyword}{struct\ }TResolveResult\ \{}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ std::vector<TAddress>\ Addresses\ =\ \{\};}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ std::exception\_ptr\ Exception\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ Retries\ =\ 0;}
\DoxyCodeLine{00182\ \ \ \ \ \};}
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00184\ \ \ \ \ \textcolor{keywordtype}{void}\ ResumeWaiters(TResolveResult\&\&\ result,\ \textcolor{keyword}{const}\ TResolveRequest\&\ req);}
\DoxyCodeLine{00185\ }
\DoxyCodeLine{00186\ \ \ \ \ std::unordered\_map<TResolveRequest,\ TResolveResult,\ TResolveRequestHash>\ Results;}
\DoxyCodeLine{00187\ \ \ \ \ std::unordered\_map<TResolveRequest,\ std::vector<std::coroutine\_handle<>>,\ TResolveRequestHash>\ WaitingAddrs;}
\DoxyCodeLine{00188\ \ \ \ \ std::unordered\_map<uint64\_t,\ TResolveRequest>\ Inflight;}
\DoxyCodeLine{00189\ }
\DoxyCodeLine{00190\ \ \ \ \ uint16\_t\ Xid\ =\ 1;}
\DoxyCodeLine{00191\ \};}
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \textcolor{keyword}{class\ }THostPort\ \{}
\DoxyCodeLine{00194\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00195\ \ \ \ \ THostPort(\textcolor{keyword}{const}\ std::string\&\ hostPort);}
\DoxyCodeLine{00196\ \ \ \ \ THostPort(\textcolor{keyword}{const}\ std::string\&\ host,\ \textcolor{keywordtype}{int}\ port);}
\DoxyCodeLine{00197\ }
\DoxyCodeLine{00198\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keyword}{typename}\ T>}
\DoxyCodeLine{00199\ \ \ \ \ \mbox{\hyperlink{struct_n_net_1_1_t_future}{TFuture<TAddress>}}\ Resolve(\mbox{\hyperlink{class_n_net_1_1_t_resolver}{TResolver<T>}}\&\ resolver);}
\DoxyCodeLine{00200\ }
\DoxyCodeLine{00201\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00202\ \ \ \ \ std::string\ Host;}
\DoxyCodeLine{00203\ \ \ \ \ \textcolor{keywordtype}{int}\ Port;}
\DoxyCodeLine{00204\ \};}
\DoxyCodeLine{00205\ }
\DoxyCodeLine{00206\ \}\ \textcolor{comment}{//\ namespace\ NNet}}

\end{DoxyCode}
